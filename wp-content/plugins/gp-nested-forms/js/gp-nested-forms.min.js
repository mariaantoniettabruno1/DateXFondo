!function(f){window.GPNestedForms=function(e){var s=this;for(prop in e)e.hasOwnProperty(prop)&&(s[prop]=e[prop]);s.init=function(){s.id=s.getDebugId(),s.$fieldContainer=f("#field_{0}_{1}".format(s.formId,s.fieldId)),s.$parentFormContainer=f("#gform_wrapper_{0}".format(s.formId)),s.$currentPage=s.$parentFormContainer.find(".gform_page:visible"),s.$modalSource=f(".gpnf-nested-form-{0}-{1}".format(s.formId,s.fieldId)),s.isActive=!1;var e=!(!s.$currentPage.length||s.$currentPage.find(s.$fieldContainer).length);if(void 0!==window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]){var t=window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)];s.entries=t.entries,t.modal.destroy(),f(document).off(".{0}".format(s.getNamespace())),window.gform.removeHook("action","gform_list_post_item_add",10,s.getNamespace()),window.gform.removeHook("action","gform_list_post_item_delete",10,s.getNamespace()),gform.removeFilter("gform_calculation_formula",10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.viewModel=t.viewModel}if(s.initKnockout(),s.initCalculations(),e)console.debug("Nested form is not visible. Skipping loading.");else{var n=s.initSession();f(document).on("click.{0}".format(s.getNamespace()),"#field_{0}_{1} .gpnf-add-entry".format(s.formId,s.fieldId),s.openAddModal),s.initModal(),s.addColorStyles(),window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]=s,gform.applyFilters("gpnf_fetch_form_html_on_load",!0,s.formId,s.fieldId,s)&&n.always(s.getFormHtml)}},s.initSession=function(){return void 0===window["gpnfSessionPromise_"+s.formId]&&(window["gpnfSessionPromise_"+s.formId]=f.post(s.ajaxUrl,s.sessionData,function(e){gform.doAction("gpnf_session_initialized",s)})),window["gpnfSessionPromise_"+s.formId]},s.initModal=function(){s.modalArgs=gform.applyFilters("gpnf_modal_args",{labels:s.modalLabels,closeLabel:s.modalLabels.closeScreenReaderLabel,colors:s.modalColors,footer:!0,stickyFooter:s.modalStickyFooter,closeMethods:["button"],cssClass:[s.modalClass,"gpnf-modal","gpnf-modal-{0}-{1}".format(s.formId,s.fieldId)],onOpen:function(){s.isActive=!0,s.$modal.find("input, select, textarea").filter(":visible").first().focus()},onClose:function(){s.clearModalContent(),s.setParentFocus(),s.isActive=!1},beforeOpen:function(){},beforeClose:function(){return!0}},s.formId,s.fieldId,s),s.modal?s.$modal=f(s.modal.modal):(s.modal=new tingle.modal(s.modalArgs),s.$modal=f(s.modal.modal),s.bindResizeEvents(),f(document).on("gpnf_post_render.{0}".format(s.getNamespace()),function(e,t,n){var o=f("#gform_wrapper_"+t);t==s.nestedFormId&&0<o.length&&s.isActive&&(s.scrollToTop(),n&&(s.initFormScripts(n),s.addModalButtons(),s.observeDefaultButtons()))}))},s.initKnockout=function(){s.viewModel&&ko.dataFor(s.$fieldContainer[0])?s.viewModel.entries(s.prepareEntriesForKnockout(s.entries)):(s.viewModel=new t(s.prepareEntriesForKnockout(s.entries),s),ko.cleanNode(s.$fieldContainer[0]),ko.applyBindings(s.viewModel,s.$fieldContainer[0]))},s.initCalculations=function(){gform.addFilter("gform_calculation_formula",s.parseCalcs,10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.runCalc(s.formId)},s.openAddModal=function(t){t.preventDefault(),t.target.disabled=!0;var e=new r(t.target,s.spinnerUrl,"");s.getFormHtml().done(function(e){s.setModalContent(e),s.openModal(f(t.target))}).always(function(){e.destroy(),t.target.disabled=!1})},s.openModal=function(e){s.saveParentFocus(e),s.modal.open(),(s.isGF25||parseInt(jQuery.fn.jquery)<3)&&f(document).trigger("gpnf_post_render",[s.nestedFormId,"1"]),s.initIframe(s.nestedFormId)},s.saveParentFocus=function(e){s.parentFocus=e},s.setParentFocus=function(){var e;switch(typeof s.parentFocus){case"undefined":return;case"function":e=s.parentFocus.apply();break;default:e=s.parentFocus}e.focus()},s.scrollToTop=function(){var e=f(s.modal.modal)[0];e.scroll?e.scroll({top:0,left:0,behavior:"smooth"}):e.scrollTop=0},s.observeDefaultButtons=function(){var e=s.getDefaultButtonObserver();s.getDefaultButtons().each(function(){e.observe(f(this)[0],{attributes:!0,childList:!0})})},s.getDefaultButtonObserver=function(){return new MutationObserver(function(e){e.forEach(function(e){"attributes"!=e.type||"style"!=e.attributeName&&"disabled"!=e.attributeName||s.addModalButtons()})})},s.setModalContent=function(e,t){f(document).off("gform_post_render.gpnf"),s.setMode(void 0===t?"add":"edit"),f(s.modal.modalBoxContent).html(void 0!==e?e:s.formHtml).prepend('<div class="gpnf-modal-header" style="background-color:{1}">{0}</div>'.format(s.getModalTitle(),s.modalHeaderColor)),s.$modal.find('input[name="gpnf_nested_form_field_id"]').val(s.fieldId),s.addModalButtons(),s.stashFormData();var n=s.getDefaultButtonObserver();s.getDefaultButtons().each(function(){n.observe(f(this)[0],{attributes:!0,childList:!0})})},s.clearModalContent=function(){f(s.modal.modalBoxContent).html("")},s.setMode=function(e){s.mode=e},s.getMode=function(){return s.mode?s.mode:"add"},s.getModalTitle=function(){return"add"===s.getMode()?s.modalArgs.labels.title:s.modalArgs.labels.editTitle},s.hasPendingUploads=function(){var n=!1;return!(!gfMultiFileUploader||!gfMultiFileUploader.uploaders)&&(f.each(gfMultiFileUploader.uploaders,function(e,t){if(0<t.total.queued)return!(n=!0)}),n)},s.addModalButtons=function(){s.modal.modalBoxFooter.innerHTML="";var e=window.gform.applyFilters("gpnf_modal_button_css_classes","tingle-btn tingle-btn--default gpnf-btn-cancel","cancel",s.formId,s.fieldId,s);s.modal.addFooterBtn(s.modalArgs.labels.cancel,e,function(){s.handleCancelClick(f(this))}),s.getDefaultButtons().each(function(){var n=f(this),e=null,t="function"==typeof window.jQuery.fn.wc_gravity_form;if("none"!==n[0].style.display||t&&""===n[0].style.display){var o="submit"===n.attr("type")||"image"===n.attr("type")?s.getSubmitButtonLabel():n.val(),r=["tingle-btn","tingle-btn--primary"],i=n.is(":disabled");n.hasClass("gform_previous_button")?(r.push("gpnf-btn-previous"),e="previous"):n.hasClass("gform_next_button")?(e="next",r.push("gpnf-btn-next")):(e="submit",r.push("gpnf-btn-submit")),r=window.gform.applyFilters("gpnf_modal_button_css_classes",r.join(" "),e,s.formId,s.fieldId,s);var a=s.modal.addFooterBtn(o,r,function(e){if(s.hasPendingUploads()){var t="undefined"!=typeof gform_gravityforms?gform_gravityforms.strings:{};alert(t.currently_uploading)}else f(e.target).addClass("gpnf-spinner"),n.click()});i&&f(a).prop("disabled",!0)}});var t=window.gform.applyFilters("gpnf_modal_button_css_classes","tingle-btn tingle-btn--default gpnf-btn-cancel-mobile","cancel-mobile",s.formId,s.fieldId,s);if(s.modal.addFooterBtn(s.modalArgs.labels.cancel,t,function(){s.handleCancelClick(f(this))}),"edit"==s.mode&&0<f(s.modal.modalBoxContent).find(".gform_wrapper").length){var n=window.gform.applyFilters("gpnf_modal_button_css_classes","tingle-btn tingle-btn--danger tingle-btn--pull-left gpnf-btn-delete","delete",s.formId,s.fieldId,s);s.modal.addFooterBtn(s.modalArgs.labels.delete,n,function(){var e=f(this),t=!1!==s.modalArgs.labels.confirmAction&&""!==s.modalArgs.labels.confirmAction;!e.data("isConfirming")&&t?(e.data("isConfirming",!0).text(s.modalArgs.labels.confirmAction),setTimeout(function(){e.data("isConfirming",!1).text(s.modalArgs.labels.delete)},3e3)):(s.getEntryRow(s.getCurrentEntryId()).find(".delete a").click(),s.modal.close())})}},s.getSubmitButtonLabel=function(){var e=s.getMode();return"add"===e&&s.modalArgs.labels.submit?s.modalArgs.labels.submit:"edit"===e&&s.modalArgs.labels.editSubmit?s.modalArgs.labels.editSubmit:s.getModalTitle()},s.addColorStyles=function(){s.$style&&"function"==typeof s.$style.remove&&s.$style.remove(),s.$style='<style type="text/css"> \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--primary { background-color: {2}; } \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--default { background-color: {3}; } \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--danger { background-color: {4}; } \t\t\t\t</style>'.format(s.formId,s.fieldId,s.modalArgs.colors.primary,s.modalArgs.colors.secondary,s.modalArgs.colors.danger),f("head").append(s.$style)},s.getDefaultButtons=function(){return f("#gform_page_{0}_{1} .gform_page_footer, #gform_{0} .gform_footer".format(s.nestedFormId,s.getCurrentPage())).find('input[type="button"], input[type="submit"], input[type="image"], button')},s.handleCancelClick=function(e){var t=window.gform.applyFilters("gpnf_disable_new_cancel_confirmation",!1===s.modalArgs.labels.confirmAction||""===s.modalArgs.labels.confirmAction);e.data("isConfirming")?s.modal.close():s.hasChanges()&&!t?(e.data("isConfirming",!0).removeClass("tingle-btn--default").addClass("tingle-btn--danger").text(s.modalArgs.labels.confirmAction),setTimeout(function(){e.data("isConfirming",!1).removeClass("tingle-btn--danger").addClass("tingle-btn--default").text(s.modalArgs.labels.cancel)},3e3)):s.modal.close()},s.setMode=function(e){s.mode=e},s.getMode=function(){return s.mode?s.mode:"add"},s.stashFormData=function(){s.formData=s.$modal.find("form").serialize()},s.hasChanges=function(){return s.$modal.find("form").serialize()!==s.formData},s.bindResizeEvents=function(){f(document).on("gpnf_post_render.{0}".format(s.getNamespace()),function(){s.modal.checkOverflow()}),f(document).on("gform_post_conditional_logic.{0}".format(s.getNamespace()),function(e,t){s.nestedFormId==t&&s.modal.checkOverflow()}),gform.addAction("gform_list_post_item_add",s.modal.checkOverflow,10,s.getNamespace()),gform.addAction("gform_list_post_item_delete",s.modal.checkOverflow,10,s.getNamespace())},s.isBound=function(e){return!!ko.dataFor(e)},s.prepareEntriesForKnockout=function(e){for(var t=0;t<e.length;t++)e[t]=s.prepareEntryForKnockout(e[t]);return e},s.prepareEntryForKnockout=function(e){var t=f.extend({},e);for(var n in t)if(e.hasOwnProperty(n)){var o=e[n];!1===o.label&&(o.label=""),e["f"+n]=o}return e},s.refreshMarkup=function(){return f.post(s.ajaxUrl,{action:"gpnf_refresh_markup",nonce:GPNFData.nonces.refreshMarkup,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){s.formHtml=e})},s.editEntry=function(t,n){var o=new r(n,s.spinnerUrl,"");n.css({visibility:"hidden"}),f.post(s.ajaxUrl,{action:"gpnf_edit_entry",nonce:GPNFData.nonces.editEntry,gpnf_entry_id:t,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){o.destroy(),n.css({visibility:"visible"}),s.setModalContent(e,"edit"),s.openModal(function(){return s.$parentFormContainer.find('[data-entryid="'+t+'"]').find("a")[0]})})},s.deleteEntry=function(t,n){var o=new r(n,s.spinnerUrl,"");n.css({visibility:"hidden"}),f.post(s.ajaxUrl,{action:"gpnf_delete_entry",nonce:GPNFData.nonces.deleteEntry,gpnf_entry_id:t.id},function(e){o.destroy(),n.css({visibility:"visible"}),e?e.success?(s.viewModel.entries.remove(t),window.gform.applyFilters("gpnf_fetch_form_html_after_delete",!0,s.formId,s.fieldId,s)&&s.refreshMarkup()):console.log("Error:"+e.data):console.log("Error: no response.")})},s.duplicateEntry=function(e,t){var n=new r(t,s.spinnerUrl,"");t.css({visibility:"hidden"}),f.post(s.ajaxUrl,{action:"gpnf_duplicate_entry",nonce:GPNFData.nonces.duplicateEntry,gpnf_entry_id:e,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){n.destroy(),t.css({visibility:"visible"}),e.success&&GPNestedForms.loadEntry(e.data),gform.doAction("gpnf_post_duplicate_entry",e.data.entry,e)})},s.getFormHtml=function(){return s.formHtml?f.when(s.formHtml):s.refreshMarkup()},s.initFormScripts=function(e){window.gform.doAction("gpnf_init_nested_form",s.nestedFormId,s),f(document).trigger("gform_post_render",[s.nestedFormId,e]),window.gformInitDatepicker&&s.$modal.find(".datepicker").each(function(){f(this).removeClass("hasDatepicker"),gformInitSingleDatepicker(f(this))}),s.handleParentMergeTag(),gform.addAction("gform_post_conditional_logic_field_action",function(e,t,n,o,r){if(s.nestedFormId==e){var i=gf_get_input_id_by_html_id(n);s.handleParentMergeTag([i])}})},s.runCalc=function(){f(document).trigger("gform_post_conditional_logic",[s.formId,[],!1])},s.parseCalcs=function(l,e,t,n){var o=getMatchGroups(l,/{[^{]*?:([0-9]+):(sum|total|count)=?([0-9]*)}/i);return f.each(o,function(e,t){var n=t[0],o=t[1],r=t[2],i=t[3],a=0;if(o==s.fieldId){switch(r){case"sum":var d=0;s.viewModel.entries().forEach(function(e){var t=0;void 0!==e[i]&&(t=e[i].value?gformToNumber(e[i].value):0),d+=parseFloat(t)}),a=d;break;case"total":d=0;s.viewModel.entries().forEach(function(e){d+=parseFloat(e.total)}),a=d;break;case"count":a=s.viewModel.entries().length}l=l.replace(n,a)}}),l},s.handleParentMergeTag=function(e){if(0===s.$modal.find(".gform_validation_error").length){var t;if(void 0!==e){var n=[];f.each(e,function(e,t){n.push("#field_{0}_{1}".format(s.nestedFormId,t))}),t=s.$modal.find(n.join(",")).find(":input")}else t=s.$modal.find(":input");t.each(function(){var e=f(this).data("gpnf-value");if(!e)return!0;if("edit"===s.mode&&!gform.applyFilters("gpnf_replace_parent_merge_tag_on_edit",!1,s.formId)){e=f(this).val();var t=s.getParentMergeTags(e);if(t.length){for(var n=0,o=t.length;n<o;n++)e=e.replace(t[n][0],"");f(this).val(e).change().trigger("chosen:updated")}return!0}var r=s.getParentMergeTags(e);if(!r)return!0;for(n=0;n<r.length;n++){var i=r[n][1];if(isNaN(i))return!0;var a=s.$parentFormContainer.find("#input_"+s.formId+"_"+i.split(".").join("_"));(a.hasClass("gfield_radio")||a.hasClass("gfield_checkbox"))&&(a=a.find("input:checked"));var d=[];-1!==r[n][0].indexOf(":label")?a.each(function(){var e=f(this);e.hasClass("gfield_select")?d.push(e.find("option:selected").text()):d.push(e.parent().find("label").text())}):a.each(function(){d.push(f(this).val())}),d=d.join(", "),d=gform.applyFilters("gpnf_parent_merge_tag_value",a.length?d:"",i,s.formId,s),e=e.replace(r[n][0],d)}e=e.trim(),f(this).val()!=e&&f(this).val(e).change().trigger("chosen:updated")})}},s.getParentMergeTags=function(e){for(var t=[],n=/{Parent:(\d+(\.\d+)?)[^\}]*}/i;n.test(e);){var o=t.length;t[o]=n.exec(e),e=e.replace(""+t[o][0],"")}return t},s.getCurrentPage=function(){var e=f("#gform_source_page_number_{0}".format(s.nestedFormId)).val();return Math.max(1,parseInt(e))},s.getCurrentEntryId=function(){return s.$modal.find('input[name="gpnf_entry_id"]').val()},s.getEntryRow=function(e){return f('.gpnf-nested-entries [data-entryid="'+e+'"]')},s.getDebugId=function(){return"xxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},s.getNamespace=function(){return"gpnf-{0}-{1}".format(s.formId,s.fieldId)},s.initIframe=function(l){f("#gform_ajax_frame_{0}".format(l)).off("load").on("load",function(){var e=f(this).contents().find("*").html();if(0<=e.indexOf("GF_AJAX_POSTBACK")){var t=f(this).contents().find("#gform_wrapper_{0}".format(l)),n=0<f(this).contents().find("#gform_confirmation_wrapper_{0}".format(l)).length,o=0<=e.indexOf("gformRedirect(){"),r=0<t.length&&!o&&!n,i=f("#gform_wrapper_{0}".format(l));if(r){i.html(t.html()),t.hasClass("gform_validation_error")?i.addClass("gform_validation_error"):i.removeClass("gform_validation_error"),setTimeout(function(){},50),window.gformInitPriceFields&&gformInitPriceFields();var a=f("#gform_source_page_number_{0}".format(l)).val();f(document).trigger("gform_page_loaded",[l,a]),window["gf_submitting_{0}".format(l)]=!1}else if(!o){var d=f(this).contents().find(".GF_AJAX_POSTBACK").html();d||(d=e),setTimeout(function(){i.replaceWith(d),f(document).trigger("gform_confirmation_loaded",[l]),window["gf_submitting_{0}".format(l)]=!1},50)}f(document).trigger("gpnf_post_render",[l,a])}})},GPNestedForms.loadEntry=function(e){var t=window["GPNestedForms_{0}_{1}".format(e.formId,e.fieldId)];if(entry=t.prepareEntryForKnockout(e.fieldValues),entry.id=e.entryId,"edit"==e.mode){var n=s.getEntryRow(entry.id).index();t.viewModel.entries.remove(function(e){return e.id==entry.id}),t.viewModel.entries.splice(n,0,entry)}else t.viewModel.entries.push(entry),window.gform.applyFilters("gpnf_fetch_form_html_after_add",!0,s.formId,s.fieldId,s)&&t.refreshMarkup();t.modal.close()},s.init()};var t=function(e,n){var t=this;t.entries=ko.observableArray(e),t.entries.subscribe(function(){n.$parentFormContainer.children("form").trigger("change")}),t.isMaxed=ko.computed(function(){var e=gform.applyFilters("gpnf_entry_limit_max",n.entryLimitMax,n.formId,n.fieldId,n);return""!==e&&t.entries().length>=e}),t.entryIds=ko.computed(function(){var n=[];return f.each(t.entries(),function(e,t){n.push(t.id)}),n},t),t.runCalc=ko.computed(function(){return n.runCalc(),t.entries().length},t),t.editEntry=function(e,t){n.editEntry(e.id,f(t.target))},t.deleteEntry=function(e,t){n.deleteEntry(e,f(t.target))},t.duplicateEntry=function(e,t){n.duplicateEntry(e.id,f(t.target))}};function r(e,t,n){return t=void 0!==t&&t?t:gf_global.base_url+"/images/spinner.gif",n=void 0!==n?n:"",this.elem=e,this.image='<img class="gfspinner" src="'+t+'" style="'+n+'" />',this.init=function(){return this.spinner=jQuery(this.image),jQuery(this.elem).after(this.spinner),this},this.destroy=function(){jQuery(this.spinner).remove()},this.init()}}(jQuery);
//# sourceMappingURL=gp-nested-forms.js.map